# Malnati/code-literal-sentinel@v3.0.17
name: "Code Literal Sentinel"
description: "Varredura com idempotÃªncia."
author: "Ricardo Malnati"

branding:
  icon: "eye"
  color: "orange"

inputs:
  token:
    description: "GitHub token."
    required: true
  file_extensions:
    description: "Regex de extensÃµes."
    required: false
    default: "ts|js|jsx|tsx|java|py|go|cs|php|sh|json|yaml|yml"
  target_path:
    description: "Caminhos de diretÃ³rios ou arquivos a serem investigados."
    required: true
    default: "ts|js|jsx|tsx|java|py|go|cs|php|sh|json|yaml|yml"
  exclude_patterns:
    description: "Regex de ignorados."
    required: false
    default: "node_modules|dist|build|.git"

outputs:
  json:
    description: "JSON de diagnÃ³stico."
    value: ${{ steps.generate_output.outputs.json }}
  status:
    description: "Status da varredura."
    value: ${{ steps.generate_output.outputs.status }}
  count:
    description: "Quantidade de literais encontrados."
    value: ${{ steps.generate_output.outputs.count }}

runs:
  using: "composite"
  steps:

    - id: check_perms
      shell: bash
      env:
        TOKEN: ${{ inputs.token }}
        TARGET_PATH: ${{ inputs.target_path }}
      run: |
        if [ -z "$TOKEN" ]; then
           echo "âŒ Token missing."
           echo "TOKEN: $TOKEN"
           exit 1
        fi
        if [ -z "$TARGET_PATH" ]; then
           echo "âŒ Target path missing."
           echo "TARGET_PATH: $TARGET_PATH"
           exit 1
        fi
        for ROOT in $TARGET_PATH; do
          if [ ! -d "$ROOT" ]; then
            echo "âŒ Caminho invÃ¡lido em TARGET_PATH: $ROOT"
            exit 1
          fi
        done
        
    - id: scan
      name: "ðŸ”Ž Scanning hardcode"
      shell: bash
      env:
        EXTS: ${{ inputs.file_extensions }}
        EXCLUDE: ${{ inputs.exclude_patterns }}
        TARGET_PATH: ${{ inputs.target_path }}
      run: |
        set -euo pipefail
        echo "EXTS: $EXTS"
        echo "EXCLUDE: $EXCLUDE"
        echo "TARGET_PATH: $TARGET_PATH"

        REPORT_DIR=".sentinel-reports"
        REPORT_NAME="hardcode-report.json"
        META_NAME="scan-meta.json"
        FULL_PATH="./$REPORT_DIR/$REPORT_NAME"
        META_PATH="./$REPORT_DIR/$META_NAME"
        mkdir -p "$REPORT_DIR"

        FILES=$(
          find "$TARGET_PATH" -type f 2>/dev/null \
            | grep -E "\.($EXTS)$" \
            | grep -vE "$EXCLUDE" || true
        )

        echo "FILES:"
        echo "$FILES" | head -n 3

        PATTERN="\"[^\"]{2,}\"|'[^']{2,}'"

        if [ -z "$FILES" ]; then
          printf '%s\n' "[]" > "$FULL_PATH"
          STATUS="NO_FILES"
          COUNT="0"
          jq -c -n \
            --arg status "$STATUS" \
            --arg count "$COUNT" \
            --arg report_path "$FULL_PATH" \
            '{status:$status, count:$count, report_path:$report_path}' > "$META_PATH"
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "report_path=$FULL_PATH" >> "$GITHUB_OUTPUT"
          echo "meta_path=$META_PATH" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        MATCHES=$(echo "$FILES" | xargs -r grep -HnE "$PATTERN" || true)
        JSON_ARRAY=$(printf '%s\n' "$MATCHES" | jq -R -s -c 'split("\n") | map(select(length>0))')
        printf '%s\n' "$JSON_ARRAY" > "$FULL_PATH"

        COUNT=$(printf '%s\n' "$MATCHES" | sed '/^$/d' | wc -l | tr -d ' ')
        echo "COUNT: $COUNT"

        if [ "$COUNT" -gt "0" ]; then
          STATUS="FOUND"
        else
          STATUS="CLEAN"
        fi

        jq -c -n \
          --arg status "$STATUS" \
          --arg count "$COUNT" \
          --arg report_path "$FULL_PATH" \
          '{status:$status, count:$count, report_path:$report_path}' > "$META_PATH"

        echo "status=$STATUS" >> "$GITHUB_OUTPUT"
        echo "count=$COUNT" >> "$GITHUB_OUTPUT"
        echo "report_path=$FULL_PATH" >> "$GITHUB_OUTPUT"
        echo "meta_path=$META_PATH" >> "$GITHUB_OUTPUT"
        
    - id: generate_output
      if: steps.circuit_breaker.outputs.skip != 'true'
      shell: bash
      env:
        GLOBAL_FOUND: ${{ steps.global_check.outputs.found }}
        GLOBAL_REF: ${{ steps.global_check.outputs.ref }}
        REPORT_PATH: ${{ steps.scan.outputs.report_path }}
        COUNT_IN: ${{ steps.scan.outputs.count }}
        STATUS_IN: ${{ steps.scan.outputs.status }}
      run: |
        set -euo pipefail

        STATUS="${STATUS_IN:-SKIPPED}"
        COUNT="${COUNT_IN:--}"

        if [ "${GLOBAL_FOUND:-}" = "true" ]; then
          STATUS="PREVIOUSLY_AUDITED"
        fi

        if [ -n "${REPORT_PATH:-}" ] && [ -f "$REPORT_PATH" ]; then
          JSON=$(cat "$REPORT_PATH")
        else
          JSON="[]"
        fi

        echo "JSON_RESULT: $JSON"
        echo "json=$JSON" >> "$GITHUB_OUTPUT"
        echo "status=$STATUS" >> "$GITHUB_OUTPUT"
        echo "count=$COUNT" >> "$GITHUB_OUTPUT"
        echo "report_path=${REPORT_PATH:-}" >> "$GITHUB_OUTPUT"
