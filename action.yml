# Malnati/code-literal-sentinel@v3.0.10
name: "Code Literal Sentinel"
description: "Varredura com idempotÃªncia."
author: "Ricardo Malnati"

branding:
  icon: "eye"
  color: "orange"

inputs:
  token:
    description: "GitHub token."
    required: true
  file_extensions:
    description: "Regex de extensÃµes."
    required: false
    default: "ts|js|jsx|tsx|java|py|go|cs|php|sh|json|yaml|yml"
  exclude_patterns:
    description: "Regex de ignorados."
    required: false
    default: "node_modules|dist|build|.git|.github/sentinel-reports"
  base:
    description: "Ramo origem."
    required: true
  head:
    description: "Ramod estino."
    required: true

outputs:
  json:
    description: "JSON de diagnÃ³stico."
    value: ${{ steps.generate_output.outputs.json }}
  status:
    description: "Status da varredura."
    value: ${{ steps.generate_output.outputs.status }}
  count:
    description: "Quantidade de literais encontrados."
    value: ${{ steps.generate_output.outputs.count }}

runs:
  using: "composite"
  steps:

    - id: check_perms
      shell: bash
      env:
        TOKEN: ${{ inputs.token }}
        BASE: ${{ inputs.base }}
        HEAD: ${{ inputs.head }}
      run: |
        if [ -z "$TOKEN" ]; then
           echo "âŒ Token missing."
           echo "TOKEN: $TOKEN"
           exit 1
        fi
        if [ -z "$BASE" ]; then
           echo "âŒ Base branch missing."
           echo "BASE: $BASE"
           exit 1
        fi
        if [ -z "$HEAD" ]; then
           echo "âŒ Head branch missing."
           echo "HEAD: $HEAD"
           exit 1
        fi
        
    - id: scan
      name: "ðŸ”Ž Scanning hardcode"
      shell: bash
      env:
        EXTS: ${{ inputs.file_extensions }}
        EXCLUDE: ${{ inputs.exclude_patterns }}
        BASE: ${{ inputs.base }}
        HEAD: ${{ inputs.head }}
      run: |
        set -euo pipefail
        echo "EXTS: $EXTS"
        echo "EXCLUDE: $EXCLUDE"
        echo "BASE: $BASE"
        echo "HEAD: $HEAD"
        
        REPORT_DIR=".sentinel-reports"
        FILENAME="hardcode-report.md"
        FULL_PATH="./$REPORT_DIR/$FILENAME"
        mkdir -p "$REPORT_DIR"

        FILES=$(git diff --name-only --diff-filter=ACMRTUXB "$BASE" "$HEAD" \
          | grep -E "\.($EXTS)$" \
          | grep -vE "$EXCLUDE" || true)

        echo "FILES:"
        echo "$FILES"

        if [ -z "$FILES" ]; then
          echo "NO_FILES" > /tmp/scan_status
          echo "0" > /tmp/scan_count
          rm -f "$FULL_PATH" || true
          echo "status=NO_FILES" >> "$GITHUB_OUTPUT"
          echo "count=0" >> "$GITHUB_OUTPUT"
          echo "report_path=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        PATTERN="\"[^\"]{2,}\"|'[^']{2,}'"
        
        echo "# ðŸ›¡ï¸ Code Literal Sentinel" > "$FULL_PATH"
        echo "> **Source SHA:** $HEAD_SHA" >> "$FULL_PATH"
        echo "> **Data:** $(date -u)" >> "$FULL_PATH"
        echo "" >> "$FULL_PATH"
        echo "\`\`\`text" >> "$FULL_PATH"
        echo "$FILES" | xargs -r grep -HnE "$PATTERN" >> "$FULL_PATH" || true
        echo "\`\`\`" >> "$FULL_PATH"

        COUNT=$(grep -cE "$PATTERN" "$FULL_PATH" || true)
        echo "COUNT: $COUNT"
        
        if [ "$COUNT" -gt "0" ]; then
           echo "FOUND" > /tmp/scan_status
           echo "$COUNT" > /tmp/scan_count
           echo "status=FOUND" >> "$GITHUB_OUTPUT"
           echo "count=$COUNT" >> "$GITHUB_OUTPUT"
           echo "report_path=$FULL_PATH" >> "$GITHUB_OUTPUT"
        else
           echo "CLEAN" > /tmp/scan_status
           echo "0" > /tmp/scan_count
           rm -f "$FULL_PATH" || true
           echo "status=CLEAN" >> "$GITHUB_OUTPUT"
           echo "count=0" >> "$GITHUB_OUTPUT"
           echo "report_path=" >> "$GITHUB_OUTPUT"
        fi

    - id: generate_output
      if: steps.circuit_breaker.outputs.skip != 'true'
      shell: bash
      env:
        GLOBAL_FOUND: ${{ steps.global_check.outputs.found }}
        GLOBAL_REF: ${{ steps.global_check.outputs.ref }}
      run: |
        set -euo pipefail

        if [ -f /tmp/scan_status ]; then
          STATUS=$(cat /tmp/scan_status)
        else
          STATUS="SKIPPED"
        fi

        if [ -f /tmp/scan_count ]; then
          COUNT=$(cat /tmp/scan_count)
        else
          COUNT="-"
        fi

        DETAIL=""
        if [ "$GLOBAL_FOUND" = "true" ]; then
          STATUS="PREVIOUSLY_AUDITED"
          CLEAN_REF=$(echo "$GLOBAL_REF" | cut -d':' -f1)
          DETAIL="A assinatura do cÃ³digo nÃ£o mudou. RelatÃ³rio existente em: \`$CLEAN_REF\`."
        fi

        if command -v jq >/dev/null 2>&1; then
          JSON=$(jq -c -n \
            --arg status "$STATUS" \
            --arg count "$COUNT" \
            --arg global_found "$GLOBAL_FOUND" \
            --arg global_ref "$GLOBAL_REF" \
            --arg detail "$DETAIL" \
            '{status:$status, count:$count, global_found:$global_found, global_ref:$global_ref, detail:$detail}')
        else
          JSON="{\"status\":\"$STATUS\",\"count\":\"$COUNT\",\"global_found\":\"$GLOBAL_FOUND\",\"global_ref\":\"$GLOBAL_REF\",\"detail\":\"$DETAIL\"}"
        fi

        echo "JSON_RESULT: $JSON"
        echo "json=$JSON" >> "$GITHUB_OUTPUT"
        echo "status=$STATUS" >> "$GITHUB_OUTPUT"
        echo "count=$COUNT" >> "$GITHUB_OUTPUT"
