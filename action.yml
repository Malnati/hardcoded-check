# Malnati/code-literal-sentinel@v2.5.0
name: "Code Literal Sentinel"
description: "Varredura com idempotÃªncia baseada em Assinatura de ConteÃºdo (Anti-Loop Definitivo)."
author: "Ricardo Malnati"

branding:
  icon: "eye"
  color: "orange"

inputs:
  token:
    description: "GitHub token."
    required: true
  file_extensions:
    description: "Regex de extensÃµes."
    required: false
    default: "ts|js|jsx|tsx|java|py|go|cs|php|sh|json|yaml|yml"
  exclude_patterns:
    description: "Regex de ignorados."
    required: false
    # Ignoramos o prÃ³prio diretÃ³rio de relatÃ³rios na geraÃ§Ã£o da assinatura
    default: "node_modules|dist|build|.git|.github/sentinel-reports"

outputs:
  result_json:
    description: "JSON de diagnÃ³stico."
    value: ${{ steps.generate_output.outputs.json_payload }}

runs:
  using: "composite"
  steps:
    # ------------------------------------------------------------------
    # STEP 0: DIAGNÃ“STICO
    # ------------------------------------------------------------------
    - id: debug_inputs
      shell: bash
      env:
        EXTS: ${{ inputs.file_extensions }}
      run: |
        echo "::group::ðŸ” Step 0: Sentinel Configuration (v2.5.0)"
        echo "âš™ï¸  Extensions: .($EXTS)"
        echo "âš™ï¸  Mode: Managed (Internal Paths)"
        echo "âš™ï¸  Strategy: Content Signature Idempotency"
        echo "::endgroup::"

    # ------------------------------------------------------------------
    # STEP 0.1: CIRCUIT BREAKER (Branch Name & Bot)
    # ------------------------------------------------------------------
    - id: circuit_breaker
      shell: bash
      env:
        HEAD_REF: ${{ github.head_ref }}
      run: |
        BOT_NAME="sentinel-bot"
        
        if [[ "$HEAD_REF" == "sentinel/"* ]]; then
           echo "ðŸ›‘ Loop Branch: Branch de auditoria ignorada."
           echo "skip=true" >> "$GITHUB_OUTPUT"
           exit 0
        fi

        # Tenta identificar se o Ãºltimo commit foi apenas de documentaÃ§Ã£o do bot
        if [ -f .git/shallow ]; then
           git fetch --depth=1 origin "$HEAD_REF" 2>/dev/null || true
        fi
        LAST_AUTHOR=$(git log -1 --pretty=format:'%an')

        if [[ "$LAST_AUTHOR" == "$BOT_NAME" ]]; then
           echo "ðŸ›‘ Loop Bot: Commit do Bot ignorado."
           echo "skip=true" >> "$GITHUB_OUTPUT"
           exit 0
        fi

        echo "skip=false" >> "$GITHUB_OUTPUT"

    # ------------------------------------------------------------------
    # STEP 0.5: PERMISSÃ•ES
    # ------------------------------------------------------------------
    - id: check_perms
      if: steps.circuit_breaker.outputs.skip != 'true'
      shell: bash
      env:
        TOKEN: ${{ inputs.token }}
      run: |
        if [ -z "$TOKEN" ]; then
           echo "âŒ Token missing."
           exit 1
        fi

    # ------------------------------------------------------------------
    # STEP 0.8: CÃLCULO DE ASSINATURA E BUSCA (A MÃ¡gica acontece aqui)
    # ------------------------------------------------------------------
    - id: global_check
      if: steps.circuit_breaker.outputs.skip != 'true'
      shell: bash
      env:
        EXTS: ${{ inputs.file_extensions }}
        EXCLUDE: ${{ inputs.exclude_patterns }}
        HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      run: |
        echo "::group::ðŸ•µï¸ Step 0.8: Content Signature Check"
        
        # 1. Gerar Assinatura do CÃ³digo Atual
        # Lista todos os arquivos trackeados, filtra pelas extensÃµes e exclusÃµes, e gera um hash do conjunto
        echo "ðŸ§® Calculando assinatura do cÃ³digo..."
        
        SIGNATURE=$(git ls-tree -r HEAD --name-only \
          | grep -E "\.($EXTS)$" \
          | grep -vE "$EXCLUDE" \
          | xargs -d '\n' git hash-object 2>/dev/null | md5sum | awk '{print $1}' || echo "empty")
          
        echo "ðŸ”‘ Assinatura Atual: $SIGNATURE"
        
        # 2. Preparar Busca HistÃ³rica
        INTERNAL_BOT_EMAIL="sentinel-bot@users.noreply.github.com"
        if [ -f .git/shallow ]; then
           git fetch --unshallow 2>/dev/null || true
        fi
        git fetch --all --quiet

        SEARCH_KEY="> **Content Signature:** $SIGNATURE"
        echo "ðŸ” Buscando relatÃ³rio prÃ©vio com esta assinatura..."

        # Busca apenas nos commits do bot
        FOUND_REF=$(git grep -I -F -l "$SEARCH_KEY" $(git rev-list --all --author="$INTERNAL_BOT_EMAIL") -- "*.md" 2>/dev/null | head -n 1 || true)
        
        if [ -n "$FOUND_REF" ]; then
           echo "âœ… RelatÃ³rio VÃ¡lido Encontrado: $FOUND_REF"
           echo "   O cÃ³digo fonte nÃ£o mudou desde a Ãºltima auditoria."
           echo "found=true" >> "$GITHUB_OUTPUT"
           echo "ref=$FOUND_REF" >> "$GITHUB_OUTPUT"
        else
           echo "âšª Nenhuma auditoria encontrada para esta assinatura de cÃ³digo."
           echo "found=false" >> "$GITHUB_OUTPUT"
           echo "signature=$SIGNATURE" >> "$GITHUB_OUTPUT"
        fi
        echo "::endgroup::"

    # ------------------------------------------------------------------
    # STEP 1: SCAN
    # ------------------------------------------------------------------
    - id: scan
      if: steps.circuit_breaker.outputs.skip != 'true' && steps.global_check.outputs.found != 'true'
      shell: bash
      env:
        BASE_SHA: ${{ github.event.pull_request.base.sha }}
        HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        EXTS: ${{ inputs.file_extensions }}
        EXCLUDE: ${{ inputs.exclude_patterns }}
        SIGNATURE: ${{ steps.global_check.outputs.signature }}
      run: |
        set -euo pipefail
        echo "ðŸ”Ž Scanning..."
        
        REPORT_DIR=".github/sentinel-reports"
        FILENAME="audit-report.md"
        FULL_PATH="./$REPORT_DIR/$FILENAME"
        mkdir -p "$REPORT_DIR"

        FILES=$(git diff --name-only --diff-filter=ACMRTUXB "$BASE_SHA" "$HEAD_SHA" \
          | grep -E "\.($EXTS)$" \
          | grep -vE "$EXCLUDE" || true)

        if [ -z "$FILES" ]; then
          echo "NO_FILES" > /tmp/scan_status
          echo "0" > /tmp/scan_count
          rm -f "$FULL_PATH"
          exit 0
        fi

        PATTERN="\"[^\"]{2,}\"|'[^']{2,}'"
        
        echo "# ðŸ›¡ï¸ Code Literal Audit" > "$FULL_PATH"
        echo "> **Content Signature:** $SIGNATURE" >> "$FULL_PATH"
        echo "> **Source SHA:** $HEAD_SHA" >> "$FULL_PATH"
        echo "> **Data:** $(date -u)" >> "$FULL_PATH"
        echo "" >> "$FULL_PATH"
        echo "\`\`\`text" >> "$FULL_PATH"
        echo "$FILES" | xargs -r grep -HnE "$PATTERN" >> "$FULL_PATH" || true
        echo "\`\`\`" >> "$FULL_PATH"

        COUNT=$(grep -cE "$PATTERN" "$FULL_PATH" || true)
        
        if [ "$COUNT" -gt "0" ]; then
           echo "FOUND" > /tmp/scan_status
           echo "$COUNT" > /tmp/scan_count
           echo "path=$FULL_PATH" >> "$GITHUB_OUTPUT"
        else
           echo "CLEAN" > /tmp/scan_status
           echo "0" > /tmp/scan_count
           rm "$FULL_PATH"
        fi

    # ------------------------------------------------------------------
    # STEP 2: GIT OPS (Mesma lÃ³gica de antes)
    # ------------------------------------------------------------------
    - id: create_pr
      if: steps.circuit_breaker.outputs.skip != 'true' && steps.global_check.outputs.found != 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        REPORT_PATH: ${{ steps.scan.outputs.path }}
        HEAD_REF: ${{ github.head_ref }}
        PR_NUM: ${{ github.event.pull_request.number }}
      run: |
        set -euo pipefail
        
        STATUS=$(cat /tmp/scan_status)
        PR_URL=""
        INTERNAL_BOT_NAME="sentinel-bot"
        INTERNAL_BOT_EMAIL="sentinel-bot@users.noreply.github.com"
        
        if [ "$STATUS" == "FOUND" ]; then
           git config user.name "$INTERNAL_BOT_NAME"
           git config user.email "$INTERNAL_BOT_EMAIL"
           
           REPORT_BRANCH="sentinel/audit/${HEAD_REF}"
           
           git checkout "$HEAD_REF"
           git checkout -B "$REPORT_BRANCH"
           git add "$REPORT_PATH"
           git commit -m "docs(sentinel): audit report [skip ci]"
           git push -f origin "$REPORT_BRANCH"
           
           gh pr create \
             --base "$HEAD_REF" \
             --head "$REPORT_BRANCH" \
             --title "ðŸ›¡ï¸ Sentinel Audit: PR #$PR_NUM" \
             --body "RelatÃ³rio de literais." || true
             
           PR_URL=$(gh pr view "$REPORT_BRANCH" --json url -q .url)
           echo "âœ… PR: $PR_URL"
        fi
        
        echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

    # ------------------------------------------------------------------
    # STEP 3: JSON OUTPUT
    # ------------------------------------------------------------------
    - id: generate_output
      if: steps.circuit_breaker.outputs.skip != 'true'
      shell: bash
      env:
        PR_URL: ${{ steps.create_pr.outputs.pr_url }}
        GLOBAL_FOUND: ${{ steps.global_check.outputs.found }}
        GLOBAL_REF: ${{ steps.global_check.outputs.ref }}
      run: |
        set -euo pipefail
        
        if [ -f /tmp/scan_status ]; then
           STATUS=$(cat /tmp/scan_status)
           COUNT=$(cat /tmp/scan_count)
        else
           STATUS="SKIPPED"
           COUNT="-"
        fi
        
        if [ "$GLOBAL_FOUND" == "true" ]; then
           STATUS="PREVIOUSLY_AUDITED"
           MSG="JÃ¡ auditado."
           CLEAN_REF=$(echo "$GLOBAL_REF" | cut -d':' -f1)
           GUIDE="A assinatura do cÃ³digo nÃ£o mudou. RelatÃ³rio existente em: \`$CLEAN_REF\`."
           COLOR="#3fb950"
        elif [ "$STATUS" == "FOUND" ]; then
           MSG="Literais detectados ($COUNT)."
           GUIDE="RelatÃ³rio gerado: **[Ver PR de Auditoria]($PR_URL)**."
           COLOR="#dbab09"
        elif [ "$STATUS" == "CLEAN" ]; then
           MSG="CÃ³digo limpo."
           GUIDE="Nenhum literal."
           COLOR="#3fb950"
        else
           MSG="Ignorado."
           GUIDE="Sem alteraÃ§Ãµes."
           COLOR="#8b949e"
        fi

        jq -n \
          --arg status "$STATUS" \
          --arg count "$COUNT" \
          --arg msg "$MSG" \
          --arg guide "$GUIDE" \
          --arg url "$PR_URL" \
          --arg color "$COLOR" \
          '{
            analysis: {
              status: $status,
              total_findings: $count,
              report_pr_url: $url
            },
            ui: {
              message: $msg,
              guidance: $guide,
              color: $color
            }
          }' > /tmp/output_payload.json

        JSON_LINE=$(jq -c . /tmp/output_payload.json)
        echo "json_payload=$JSON_LINE" >> "$GITHUB_OUTPUT"
